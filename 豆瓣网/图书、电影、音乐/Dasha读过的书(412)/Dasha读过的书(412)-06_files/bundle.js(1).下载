!function(){"use strict";!function(t){function e(e,n,a,l){var r={data:l||(n?n.data:{}),_wrap:n?n._wrap:null,tmpl:null,parent:n||null,nodes:[],calls:u,nest:c,wrap:p,html:d,update:f};return e&&t.extend(r,e,{nodes:[],parent:n}),a&&(r.tmpl=a,r._ctnt=r._ctnt||r.tmpl(t,r),r.key=++k,(b.length?_:y)[k]=r),r}function n(e,l,r){var i,o=r?t.map(r,function(t){return"string"==typeof t?e.key?t.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+g+'="'+e.key+'" $2'):t:n(t,e,t._ctnt)}):e;return l?o:(o=o.join(""),o.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(e,n,l,r){i=t(l).get(),s(i),n&&(i=a(n).concat(i)),r&&(i=i.concat(a(r)))}),i||a(o))}function a(e){var n=document.createElement("div");return n.innerHTML=e,t.makeArray(n.childNodes)}function l(e){return new Function("jQuery","$item","var $=jQuery,call,_=[],$data=$item.data;with($data){_.push('"+t.trim(e).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(e,n,a,l,r,o,s){var u,c,p,d=t.tmpl.tag[a];if(!d)throw"Template command not found: "+a;return u=d._default||[],o&&!/\w$/.test(r)&&(r+=o,o=""),r?(r=i(r),s=s?","+i(s)+")":o?")":"",c=o?r.indexOf(".")>-1?r+i(o):"("+r+").call($item"+s:r,p=o?c:"(typeof("+r+")==='function'?("+r+").call($item):("+r+"))"):p=c=u.$1||"null",l=i(l),"');"+d[n?"close":"open"].split("$notnull_1").join(r?"typeof("+r+")!=='undefined' && ("+r+")!=null":"true").split("$1a").join(p).split("$1").join(c).split("$2").join(l?l.replace(/\s*([^\(]+)\s*(\((.*?)\))?/g,function(t,e,n,a){return a=a?","+a+")":n?")":"",a?"("+e+").call($item"+a:t}):u.$2||"")+"_.push('"})+"');}return _;")}function r(e,a){e._wrap=n(e,!0,t.isArray(a)?a:[$.test(a)?a:t(a).html()]).join("")}function i(t){return t?t.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function o(t){var e=document.createElement("div");return e.appendChild(t.cloneNode(!0)),e.innerHTML}function s(n){function a(n){function a(t){t+=u,i=c[t]=c[t]||e(i,y[i.parent.key+u]||i.parent)}var l,r,i,o,s=n;if(o=n.getAttribute(g)){for(;s.parentNode&&1===(s=s.parentNode).nodeType&&!(l=s.getAttribute(g)););l!==o&&(s=s.parentNode?11===s.nodeType?0:s.getAttribute(g)||0:0,(i=y[o])||(i=_[o],i=e(i,y[s]||_[s]),i.key=++k,y[k]=i),w&&a(o)),n.removeAttribute(g)}else w&&(i=t.data(n,"tmplItem"))&&(a(i.key),y[i.key]=i,s=t.data(n.parentNode,"tmplItem"),s=s?s.key:0);if(i){for(r=i;r&&r.key!=s;)r.nodes.push(n),r=r.parent;delete i._ctnt,delete i._wrap,t.data(n,"tmplItem",i)}}var l,r,i,o,s,u="_"+w,c={};for(i=0,o=n.length;i<o;i++)if(1===(l=n[i]).nodeType){for(r=l.getElementsByTagName("*"),s=r.length-1;s>=0;s--)a(r[s]);a(l)}}function u(t,e,n,a){if(!t)return b.pop();b.push({_:t,tmpl:e,item:this,data:n,options:a})}function c(e,n,a){return t.tmpl(t.template(e),n,a,this)}function p(e,n){var a=e.options||{};return a.wrapped=n,t.tmpl(t.template(e.tmpl),e.data,a,e.item)}function d(e,n){var a=this._wrap;return t.map(t(t.isArray(a)?a.join(""):a).filter(e||"*"),function(t){return n?t.innerText||t.textContent:t.outerHTML||o(t)})}function f(){var e=this.nodes;t.tmpl(null,null,null,this).insertBefore(e[0]),t(e).remove()}var m,h=t.fn.domManip,g="_tmplitem",$=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,y={},_={},v={key:0,data:{}},k=0,w=0,b=[];t.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,n){t.fn[e]=function(a){var l,r,i,o,s=[],u=t(a),c=1===this.length&&this[0].parentNode;if(m=y||{},c&&11===c.nodeType&&1===c.childNodes.length&&1===u.length)u[n](this[0]),s=this;else{for(r=0,i=u.length;r<i;r++)w=r,l=(r>0?this.clone(!0):this).get(),t(u[r])[n](l),s=s.concat(l);w=0,s=this.pushStack(s,e,u.selector)}return o=m,m=null,t.tmpl.complete(o),s}}),t.fn.extend({tmpl:function(e,n,a){return t.tmpl(this[0],e,n,a)},tmplItem:function(){return t.tmplItem(this[0])},template:function(e){return t.template(e,this[0])},domManip:function(e,n,a){if(e[0]&&t.isArray(e[0])){for(var l,r=t.makeArray(arguments),i=e[0],o=i.length,s=0;s<o&&!(l=t.data(i[s++],"tmplItem")););l&&w&&(r[2]=function(e){t.tmpl.afterManip(this,e,a)}),h.apply(this,r)}else h.apply(this,arguments);return w=0,!m&&t.tmpl.complete(y),this}}),t.extend({tmpl:function(a,l,i,o){var s,u=!o;if(u)o=v,a=t.template[a]||t.template(null,a),_={};else if(!a)return a=o.tmpl,y[o.key]=o,o.nodes=[],o.wrapped&&r(o,o.wrapped),t(n(o,null,o.tmpl(t,o)));return a?("function"==typeof l&&(l=l.call(o||{})),i&&i.wrapped&&r(i,i.wrapped),s=t.isArray(l)?t.map(l,function(t){return t?e(i,o,a,t):null}):[e(i,o,a,l)],u?t(n(o,null,s)):s):[]},tmplItem:function(e){var n;for(e instanceof t&&(e=e[0]);e&&1===e.nodeType&&!(n=t.data(e,"tmplItem"))&&(e=e.parentNode););return n||v},template:function(e,n){return n?("string"==typeof n?n=l(n):n instanceof t&&(n=n[0]||{}),n.nodeType&&(n=t.data(n,"tmpl")||t.data(n,"tmpl",l(n.innerHTML))),"string"==typeof e?t.template[e]=n:n):e?"string"!=typeof e?t.template(null,e):t.template[e]||t.template(null,$.test(e)?e:t(e)):null},encode:function(t){return(""+t).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}}),t.extend(t.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},if:{open:"if(($notnull_1) && $1a){",close:"}"},else:{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){_.push($.encode($1a));}"},"!":{open:""}},complete:function(){y={}},afterManip:function(e,n,a){var l=11===n.nodeType?t.makeArray(n.childNodes):1===n.nodeType?[n]:[];a.call(e,n),s(l),w++}})}(jQuery),function(t){t.fn.iSuggest=function(e){function n(e){if(s&&s.abort(),/27$|38$|40$/.test(e.keyCode)&&d.is(":visible"))switch(e.preventDefault(),e.keyCode){case 38:i("up");break;case 40:i("down");break;case 27:d.hide()}else if(/13$/.test(e.keyCode)&&d.find("."+f.currClass).length)e.preventDefault(),o(d.find("."+f.currClass));else{try{clearTimeout(u),u=null}catch(e){}u=setTimeout(function(){a(t.trim(p.val()))},f.delay_ms)}}function a(e){e.length?s=t.get(f.api,{q:e},function(n){n.length?(t("#search_suggest ul").empty(),l(n,e)):d.hide()}):d.hide()}function l(e,n){e.length&&(t.each(e,function(t,e){e.keyword=n,e.index=t}),t("#search_suggest ul").html(t("#"+f.tmplId).tmpl(e)),r(),d.show(),t("#search_suggest ul").delegate("li","click",function(){o(this)}))}function r(){var t=p.offset(),e=p.outerHeight(!1);d.css({top:t.top+e+"px",left:t.left+"px"})}function i(t){var e=d.find("."+f.currClass);e.length?(e.removeClass(f.currClass),"up"==t?e.prev("li").length?e.prev("li").addClass(f.currClass):d.find("li:last").addClass(f.currClass):"down"==t&&(e.next("li").length?e.next("li").addClass(f.currClass):d.find("li:first").addClass(f.currClass))):"up"==t?d.find("li:last").addClass(f.currClass):"down"==t&&d.find("li:first").addClass(f.currClass)}function o(e){t.isFunction(f.item_act)?f.item_act(e):console.error("iSuggest: call back is not a function")}var s,u,c={api:"",delay_ms:800,tmplId:"suggResult",currClass:"curr_item"},p=t(this),d=t("<div id='search_suggest'><ul></ul></div>"),f=t.extend({},c,e);return d.appendTo("body").hide(),p.blur(function(){setTimeout(function(){d.hide()},300)}),t(window).load(r).resize(r),p.each(function(){p.attr("autocomplete","off"),p.keyup(function(t){n(t)}).keydown(function(t){/27$|38$|40$/.test(t.keyCode)&&d.is(":visible")&&t.preventDefault()})})}}(jQuery);var t=function(t){var e,n,a=t+"=",l=document.cookie.split(";");for(e=0;e<l.length;e++){for(n=l[e];" "==n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(a))return n.substring(a.length,n.length).replace(/\"/g,"")}return null};$(function(){function e(t){var e=$.extend({ck:l},t.data);"POST"==t.type&&(e=JSON.stringify(e)),$.ajax({type:t.type||"GET",url:t.url,data:e,dataType:t.dataType||"json",xhrFields:{withCredentials:!0},crossDomain:!0,contentType:"application/json",success:function(e){0!==e.r?t.error?t.error(e.error,e.data,e):e.error&&console.info(e.error):t.success&&t.success(e)},error:function(t,e,n){console.info("服务器开小差，请稍后再试")}})}function n(t){$("li.book-cart a",".nav-secondary").text("购物车("+t+")")}var a="https://market.douban.com/api/v2/cart/",l=t("ck");l&&e({url:a+"quantity?biz_type=book",success:function(t){0===t.r?n(t.data.quantity||0):console.info(t.error)},error:function(t){console.warn(t)}}),$("a.btn-cart","div.market-banner").on("click",function(t){t.preventDefault();var l=$(this);l.hasClass("disabled")||(l.addClass("disabled").text("已加入购物车"),e({url:a+"items",type:"POST",data:{sku_id:String(l.attr("data-id")),quantity:1},success:function(t){n(t.data.total_quantity||0)}}))})}),$("#db-nav-book").find("input[name=search_text]").iSuggest({api:"https://book.douban.com/j/subject_suggest",tmplId:"suggResult",item_act:function(t){window.location=$(t).data("link")}})}();
